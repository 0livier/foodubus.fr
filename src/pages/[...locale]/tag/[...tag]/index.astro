---
import { getCollection } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import config, { monolocale } from "$config";
import Base from "$layouts/Base.astro";
import Time from "$utils/time";
import Icon from "$components/Icon.svelte";
import i18nit from "$i18n";
import { tagSlug } from "$utils/slug";
import { getTagIntro } from "$utils/tag-intros";
import { canonicalPagePath } from "$utils/canonical-url";

export async function getStaticPaths() {
	const notes = await getCollection("note", (n) => !n.data.draft);
	const jottings = await getCollection("jotting", (j) => !j.data.draft);

	// Collect (tag, locale) and group by slug so one URL per slug (tags that slug the same share a page)
	const slugToTagsByLocale = new Map<string, Map<string, Set<string>>>();
	function addTag(tag: string, locale: string) {
		const slug = tagSlug(tag);
		if (!slugToTagsByLocale.has(slug)) slugToTagsByLocale.set(slug, new Map());
		const byLocale = slugToTagsByLocale.get(slug)!;
		if (!byLocale.has(locale)) byLocale.set(locale, new Set());
		byLocale.get(locale)!.add(tag);
	}
	for (const note of notes) {
		const locale = monolocale ? config.i18n.defaultLocale : note.id.split("/")[0];
		note.data.tags?.forEach((tag: string) => addTag(tag, locale));
	}
	for (const jotting of jottings) {
		const locale = monolocale ? config.i18n.defaultLocale : jotting.id.split("/")[0];
		jotting.data.tags?.forEach((tag: string) => addTag(tag, locale));
	}

	const paths: { params: { locale?: string; tag: string }; props: { tags: string[] } }[] = [];
	for (const locale of config.i18n.locales) {
		const localeParam = config.i18n.defaultLocale === locale ? undefined : locale;
		for (const [slug, byLocale] of slugToTagsByLocale) {
			const tags = byLocale.get(locale);
			if (!tags?.size) continue;
			paths.push({
				params: { locale: localeParam, tag: slug },
				props: { tags: Array.from(tags) }
			});
		}
	}
	return paths;
}

const { locale = config.i18n.defaultLocale, tag: tagSlugParam } = Astro.params;
const { tags: tagList } = Astro.props;
const tag = [...tagList].sort((a, b) => a.localeCompare(b))[0]; // primary tag for heading
const tagSlug = typeof tagSlugParam === "string" ? tagSlugParam : tagSlugParam?.[0];
const tagIntro = tagSlug ? getTagIntro(tagSlug) : undefined;

const t = i18nit(locale);

const notes = await getCollection("note", (note) => {
	if (note.data.draft) return false;
	const localed = monolocale || note.id.split("/")[0] === locale;
	return localed && note.data.tags?.some((t) => tagList.includes(t));
});
const jottings = await getCollection("jotting", (jotting) => {
	if (jotting.data.draft) return false;
	const localed = monolocale || jotting.id.split("/")[0] === locale;
	return localed && jotting.data.tags?.some((t) => tagList.includes(t));
});

const noteItems = notes.map((n) => ({
	type: "note" as const,
	id: n.id,
	title: n.data.title,
	timestamp: n.data.timestamp,
	series: n.data.series,
	sensitive: n.data.sensitive,
	top: n.data.top
}));
const jottingItems = jottings.map((j) => ({
	type: "jotting" as const,
	id: j.id,
	title: j.data.title,
	timestamp: j.data.timestamp,
	sensitive: j.data.sensitive,
	top: j.data.top
}));
const items = [...noteItems, ...jottingItems].sort(
	(a, b) => b.top - a.top || b.timestamp.getTime() - a.timestamp.getTime()
);

function itemId(item: (typeof items)[0]): string {
	return monolocale ? item.id : item.id.split("/").slice(1).join("/");
}
function itemHref(item: (typeof items)[0]): string {
	return getRelativeLocaleUrl(locale, canonicalPagePath(`/${item.type}/${itemId(item)}`));
}
---

<Base title={t("tag.title", { tag })} {locale}>
	<main class="flex flex-col gap-6 grow">
		<header class="flex flex-col gap-2">
			<h1>{t("tag.heading", { tag })}</h1>
			<p class="text-secondary text-sm">{t("tag.count", { count: items.length })}</p>
		</header>
		{tagIntro && (
			<p class="text-secondary max-w-prose">
				{tagIntro}
			</p>
		)}
		<ul class="flex flex-col gap-4">
			{items.map((item) => (
				<li>
					<section class="flex flex-col gap-2 sm:flex-row sm:items-center">
						<div class="flex flex-col gap-1">
							<div class="inline-flex gap-1 items-center flex-wrap [&:not(:has(*))]:hidden">
								{item.top > 0 && <Icon name="lucide--flag-triangle-right" class="rtl:-scale-x-100" />}
								{item.sensitive && <Icon name="lucide--siren" title={t("sensitive.icon")} />}
								{item.type === "note" && "series" in item && item.series && (
									<span class="text-secondary">{item.series}</span>
								)}
							</div>
							<a href={itemHref(item)} class="link font-medium">
								{item.title}
							</a>
							<time
								datetime={item.timestamp.toISOString()}
								class="font-mono text-[0.65rem] leading-none text-remark"
							>
								{Time.date.locale(item.timestamp, locale)}
							</time>
						</div>
						<span class="sm:ms-auto text-remark text-sm">
							{t(`navigation.${item.type}`)}
						</span>
					</section>
				</li>
			))}
		</ul>
		{items.length === 0 && (
			<p class="text-secondary">{t("tag.empty")}</p>
		)}
	</main>
</Base>
